name: Test OIDC Publishing (Dry Run)

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable verbose npm debugging'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  test-oidc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug - Check npm CLI version
        run: |
          echo "=== NPM Version ==="
          npm --version
          echo "=== Node Version ==="
          node --version

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Debug - Check environment after setup-node
        run: |
          echo "=== Environment Variables (filtered) ==="
          env | grep -i npm || true
          env | grep -i node || true
          env | grep -i token || true
          env | grep -i registry || true
          echo "=== .npmrc contents ==="
          cat ~/.npmrc || echo "No .npmrc found"
          cat .npmrc || echo "No local .npmrc found"

      - name: Debug - Check OIDC token availability
        run: |
          echo "=== OIDC Token Check ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL is set: $([[ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]] && echo 'YES' || echo 'NO')"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is set: $([[ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]] && echo 'YES' || echo 'NO')"

      - run: npm install

      - name: Test npm whoami (checks auth)
        continue-on-error: true
        run: |
          echo "=== Testing npm auth ==="
          npm whoami 2>&1 || echo "npm whoami failed (expected if OIDC not working)"

      - name: Dry-run publish with verbose output
        run: |
          echo "=== Dry-run publish ==="
          npm publish --dry-run --access public ${{ inputs.debug_mode == 'true' && '--loglevel verbose' || '' }} 2>&1