name: Test OIDC Publishing

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable verbose npm debugging'
        required: false
        default: 'true'
        type: boolean
      real_publish:
        description: 'Do REAL publish (not dry-run) - publishes 0.0.0-oidc-test.1'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  test-oidc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug - Check npm CLI version
        run: |
          echo "=== NPM Version ==="
          npm --version
          echo "=== Node Version ==="
          node --version

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Debug - Check environment after setup-node
        run: |
          echo "=== Environment Variables (filtered) ==="
          env | grep -i npm || true
          env | grep -i node || true
          env | grep -i token || true
          env | grep -i registry || true
          echo "=== .npmrc locations ==="
          echo "NPM_CONFIG_USERCONFIG=${NPM_CONFIG_USERCONFIG:-not set}"
          echo "=== temp .npmrc (setup-node created) ==="
          cat /home/runner/work/_temp/.npmrc || echo "No temp .npmrc found"
          echo "=== ~/.npmrc ==="
          cat ~/.npmrc || echo "No ~/.npmrc found"
          echo "=== local .npmrc ==="
          cat .npmrc || echo "No local .npmrc found"
          echo "=== NODE_AUTH_TOKEN value (first 10 chars) ==="
          echo "${NODE_AUTH_TOKEN:0:10}..." || echo "NODE_AUTH_TOKEN not set"

      - name: Debug - Check OIDC token availability
        run: |
          echo "=== OIDC Token Check ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL is set: $([[ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]] && echo 'YES' || echo 'NO')"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is set: $([[ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]] && echo 'YES' || echo 'NO')"

      - run: npm install

      - name: Test npm whoami (checks auth)
        continue-on-error: true
        run: |
          echo "=== Testing npm auth ==="
          npm whoami 2>&1 || echo "npm whoami failed (expected if OIDC not working)"

      - name: Dry-run publish with verbose output
        run: |
          echo "=== Dry-run publish ==="
          npm publish --dry-run --access public ${{ inputs.debug_mode == 'true' && '--loglevel verbose' || '' }} 2>&1

  # Second job: Test WITHOUT registry-url to see if OIDC works directly
  test-oidc-no-registry-url:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          # NO registry-url - let npm handle OIDC directly

      - name: Debug - Check environment (no registry-url)
        run: |
          echo "=== Without registry-url ==="
          echo "NPM_CONFIG_USERCONFIG=${NPM_CONFIG_USERCONFIG:-not set}"
          echo "NODE_AUTH_TOKEN=${NODE_AUTH_TOKEN:-not set}"
          cat /home/runner/work/_temp/.npmrc 2>/dev/null || echo "No temp .npmrc"
          echo "=== OIDC vars ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL is set: $([[ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]] && echo 'YES' || echo 'NO')"

      - name: Upgrade npm to 11.x (required for OIDC)
        run: |
          echo "=== Current npm version ==="
          npm --version
          echo "=== Upgrading to npm@latest (11.x) ==="
          npm install -g npm@latest
          echo "=== New npm version ==="
          npm --version

      - name: Configure npm registry manually
        run: |
          npm config set registry https://registry.npmjs.org/
          echo "=== npm config list ==="
          npm config list

      - run: npm install

      - name: Set test version for OIDC test
        if: ${{ inputs.real_publish }}
        run: |
          npm version 0.0.0-oidc-test.1 --no-git-tag-version
          echo "=== package.json version ==="
          grep '"version"' package.json

      - name: Dry-run publish (no registry-url variant)
        if: ${{ !inputs.real_publish }}
        continue-on-error: true
        run: |
          echo "=== Dry-run publish without registry-url ==="
          npm publish --dry-run --access public --loglevel verbose 2>&1

      - name: REAL publish via OIDC (test version)
        if: ${{ inputs.real_publish }}
        run: |
          echo "=== REAL PUBLISH via OIDC ==="
          echo "Publishing version 0.0.0-oidc-test.1 to npm..."
          echo "Using --provenance flag to trigger OIDC token exchange"
          npm publish --access public --provenance --tag oidc-test --loglevel verbose 2>&1
          echo "=== SUCCESS! OIDC publishing works! ==="